<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‚ØµÙ Ù…Ø¯Ø±Ø³Ø©</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js" type="module"></script>

  <style>
    :root{
      --brand:#2D5D55; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø´Ø±ÙŠØ· */
      --field-font:18px; --field-pad:14px; --btn-font:18px; --btn-pad:14px 22px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma, Arial, system-ui;background:#F5F6F3;color:#0a2342}
    header{background:var(--brand);color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px}
    header #dateNice{color:#fff}
    .container{max-width:1200px;margin:24px auto;padding:14px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.10);padding:18px;margin-bottom:16px}
    nav.tabs{display:flex;gap:10px;flex-wrap:wrap}
    nav.tabs button{background:transparent;border:1px solid #d9e0e7;padding:12px 16px;border-radius:14px;cursor:pointer;font-size:17px;color:var(--brand)}
    nav.tabs button.active{background:var(--brand);color:#fff}
    label{display:block;font-size:15px;color:#5f6b7a;margin-bottom:6px}
    input[type=text],input[type=password],input[type=number],input[type=date],select,textarea{width:100%;padding:var(--field-pad);border-radius:12px;border:1px solid #e3e7ea;background:#fff;font-size:var(--field-font)}
    button.primary{background:#2563eb;color:#fff;border:none;padding:var(--btn-pad);border-radius:12px;font-size:var(--btn-font);cursor:pointer}
    button.ghost{background:transparent;border:1px solid #d1d5db;padding:var(--btn-pad);border-radius:12px;font-size:var(--btn-font);cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .row{display:flex;gap:10px;align-items:center}
    .hidden{display:none!important}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:center}
    th{background:var(--brand);color:#fff}
    .auth-actions{display:flex;gap:14px;justify-content:center;margin-top:18px}
    @media (max-width:900px){.grid,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1 id="schoolBar">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‚ØµÙ Ù…Ø¯Ø±Ø³Ø©</h1>
    <div class="row">
      <div id="dateNice"></div>
      <button id="btnShowLogin" class="ghost">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    </div>
  </header>

  <div class="container">
    <div id="authCard" class="card">
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" type="text" placeholder="name@example.com" />
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
          <input id="schoolName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ù‚Ø¯Ø³" />
        </div>
      </div>
      <div class="auth-actions">
        <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
        <button id="btnSignup" class="ghost">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>

    <div id="appUI" class="hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <nav class="tabs" id="mainTabs">
            <button data-page="purchases" class="active">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
            <button data-page="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
            <button data-page="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
          </nav>
          <div class="row" style="font-size:16px">
            <div id="signedAs" style="color:#5f6b7a"></div>
            <button id="btnLogout" class="ghost">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </div>

      <section id="purchases" class="card">
        <h3 style="margin-top:0">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
        <div class="grid">
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="purchaseDate"></div>
          <div><label>Ø§Ù„ÙŠÙˆÙ…</label><input type="text" id="purchaseDay" disabled></div>
          <div><label>Ø§Ù„ØµÙ†Ù</label>
            <select id="purchaseItem"><option>Ù…Ø§Ø¡</option><option>Ø¹ØµÙŠØ±</option><option>ÙØ·Ø§ÙŠØ±</option></select>
          </div>
          <div><label>Ø§Ù„Ø¹Ø¯Ø¯</label><input type="number" id="purchaseQty" min="1" value="1"></div>
          <div><label>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø©</label><input type="number" id="purchaseCost" min="0" step="0.01" value="0"></div>
          <div><label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„ÙˆØ­Ø¯Ø©</label><input type="number" id="purchasePrice" min="0" step="0.01" value="0"></div>
        </div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="purchaseNote" rows="2"></textarea>
        <div class="row" style="margin-top:12px">
          <button id="btnAddPurchase" class="primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
          <button id="btnClearPurchase" class="ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <button id="btnTogglePurchaseTable" class="ghost">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
          <div style="flex:1"></div>
          <div style="color:#5f6b7a">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ…: <span id="totalInventory">0</span></div>
        </div>
        <div id="purchaseFilters" class="row hidden" style="flex-wrap:wrap;margin-top:10px">
          <div><label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="filterPurchaseDate"></div>
          <div><label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù</label>
            <select id="filterPurchaseItem"><option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option><option>Ù…Ø§Ø¡</option><option>Ø¹ØµÙŠØ±</option><option>ÙØ·Ø§ÙŠØ±</option></select>
          </div>
          <div class="row"><button id="btnApplyPurchaseFilters" class="primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button><button id="btnResetPurchaseFilters" class="ghost">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button></div>
        </div>
        <table id="purchaseTable" class="hidden">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>ØªÙƒÙ„ÙØ©/ÙˆØ­Ø¯Ø©</th><th>Ø¨ÙŠØ¹/ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="sales" class="card hidden">
        <h3 style="margin-top:0">ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
        <div class="grid">
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="saleDate"></div>
          <div><label>Ø§Ù„ÙŠÙˆÙ…</label><input type="text" id="saleDay" disabled></div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="grid-3">
            <div>
              <div style="color:#5f6b7a;margin-bottom:8px">Ù…Ø§Ø¡ â€” Ù…ØªÙˆÙØ±: <strong id="avail-water">0</strong> | Ø³Ø¹Ø± Ø¨ÙŠØ¹: <strong id="price-water">â€”</strong> | ØªÙƒÙ„ÙØ©: <strong id="cost-water">â€”</strong></div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (Ù…Ø§Ø¡)</label><input type="number" id="qty-water" min="0" value="0">
            </div>
            <div>
              <div style="color:#5f6b7a;margin-bottom:8px">Ø¹ØµÙŠØ± â€” Ù…ØªÙˆÙØ±: <strong id="avail-juice">0</strong> | Ø³Ø¹Ø± Ø¨ÙŠØ¹: <strong id="price-juice">â€”</strong> | ØªÙƒÙ„ÙØ©: <strong id="cost-juice">â€”</strong></div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (Ø¹ØµÙŠØ±)</label><input type="number" id="qty-juice" min="0" value="0">
            </div>
            <div>
              <div style="color:#5f6b7a;margin-bottom:8px">ÙØ·Ø§ÙŠØ± â€” Ù…ØªÙˆÙØ±: <strong id="avail-pie">0</strong> | Ø³Ø¹Ø± Ø¨ÙŠØ¹: <strong id="price-pie">â€”</strong> | ØªÙƒÙ„ÙØ©: <strong id="cost-pie">â€”</strong></div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (ÙØ·Ø§ÙŠØ±)</label><input type="number" id="qty-pie" min="0" value="0">
            </div>
          </div>
        </div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="saleNote" rows="2"></textarea>
        <div class="row" style="margin-top:12px">
          <button id="btnAddSale" class="primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹</button>
          <button id="btnClearSale" class="ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <button id="btnToggleSalesTable" class="ghost">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
          <div style="flex:1"></div>
          <div style="color:#5f6b7a">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <span id="dayRevenue">0</span></div>
        </div>
        <div id="salesFilters" class="row hidden" style="flex-wrap:wrap;margin-top:10px">
          <div><label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="filterSalesDate"></div>
          <div><label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù</label>
            <select id="filterSalesItem"><option value="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</option><option>Ù…Ø§Ø¡</option><option>Ø¹ØµÙŠØ±</option><option>ÙØ·Ø§ÙŠØ±</option></select>
          </div>
          <div class="row"><button id="btnApplySalesFilters" class="primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button><button id="btnResetSalesFilters" class="ghost">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button></div>
        </div>
        <table id="salesTable" class="hidden">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="reports" class="card hidden">
        <h3 style="margin-top:0">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
        <div class="grid">
          <div>
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="reportStartDate">
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="reportEndDate">
          </div>
          <div style="align-self:end">
            <div class="row">
              <button id="btnRefreshReports" class="primary">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="card"><div style="color:#5f6b7a">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ø´ØªØ±ÙŠØ§Øª)</div><div id="sumCost" style="font-weight:700;font-size:22px">0</div></div>
          <div class="card"><div style="color:#5f6b7a">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ù…Ø¨ÙŠØ¹Ø§Øª)</div><div id="sumRevenue" style="font-weight:700;font-size:22px">0</div></div>
          <div class="card"><div style="color:#5f6b7a">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div id="sumProfit" style="font-weight:700;font-size:22px">0</div></div>
          <div class="card"><div style="color:#5f6b7a">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ (5%)</div><div id="sumDepreciation" style="font-weight:700;font-size:22px">0</div></div>
          <div class="card"><div style="color:#5f6b7a">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div id="sumNetProfit" style="font-weight:700;font-size:22px">0</div></div>
        </div>
        <table id="reportPurchaseTable" style="margin-top:12px">
          <thead><tr><th colspan="7">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</th></tr><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ©/ÙˆØ­Ø¯Ø©</th><th>Ø¨ÙŠØ¹/ÙˆØ­Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="reportSalesTable" style="margin-top:12px">
          <thead><tr><th colspan="6">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</th></tr><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>

        <hr>
        <div class="row" style="justify-content:space-between;align-items:center; margin-top: 24px;">
            <div class="row">
                <label for="deleteDate">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="deleteDate" style="width: auto;">
            </div>
            <button id="btnDeleteData" class="primary" style="background-color: #dc2626; padding: 10px 16px; font-size: 16px;">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1kqqJ1LgkFe9OZR-5ZepjU_x7Qa6TwNI",
      authDomain: "sales-follow-up-cf06d.firebaseapp.com",
      projectId: "sales-follow-up-cf06d",
      storageBucket: "sales-follow-up-cf06d.firebasestorage.app",
      messagingSenderId: "888690138424",
      appId: "1:888690138424:web:7cb8274b840e0f7d31b5cd",
      measurementId: "G-K270SL5FPW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = s=>document.querySelector(s);
    const fmt = n => Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});

    // ØªØ§Ø±ÙŠØ® ÙˆØ£ÙŠØ§Ù…
    const toISO = d => d.toISOString().slice(0,10);
    const today = new Date();
    $('#dateNice').textContent = new Intl.DateTimeFormat('ar-SA',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(today);
    ['purchaseDate','saleDate','reportStartDate','reportEndDate'].forEach(id=>{ const el=$('#'+id); if(el) el.value = toISO(new Date()); });
    ['purchaseDay','saleDay'].forEach(id=>{ const el=$('#'+id); if(el) el.value = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(new Date()); });
    $('#purchaseDate')?.addEventListener('change',()=> $('#purchaseDay').value = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(new Date($('#purchaseDate').value)));
    $('#saleDate')?.addEventListener('change',()=> $('#saleDay').value = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(new Date($('#saleDate').value)));
    $('#deleteDate')?.addEventListener('change', () => {
        if ($('#deleteDate').value === '') {
            $('#btnDeleteData').textContent = 'Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        } else {
            $('#btnDeleteData').textContent = 'Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        }
    });

    // Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±ÙŠØ¯
    const emailInput = $('#email');
    const schoolInput = $('#schoolName');
    function setSchoolHeader(name){ const s = name && name.trim()? `Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‚ØµÙ Ù…Ø¯Ø±Ø³Ø© â€” ${name}` : 'Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‚ØµÙ Ù…Ø¯Ø±Ø³Ø©'; $('#schoolBar').textContent = s; document.title=s; }
    emailInput?.addEventListener('input', ()=>{ const e=emailInput.value.trim().toLowerCase(); const saved=localStorage.getItem(`schoolByEmail:${e}`)||''; if(saved){ schoolInput.value=saved; setSchoolHeader(saved); } });
    function saveSchoolForEmail(){ const e=emailInput.value.trim().toLowerCase(); const s=schoolInput.value.trim(); if(e && s){ localStorage.setItem(`schoolByEmail:${e}`,s); setSchoolHeader(s); } }

    // Ø¯Ø®ÙˆÙ„/ØªØ³Ø¬ÙŠÙ„
    $('#btnShowLogin').addEventListener('click', ()=>{ window.scrollTo(0,0); $('#authCard').scrollIntoView(); });
    $('#btnLogin').addEventListener('click', async ()=>{ const email=$('#email').value.trim(); const pass=$('#password').value; saveSchoolForEmail(); if(!email||!pass) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); try{ await signInWithEmailAndPassword(auth,email,pass);}catch(e){ alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+e.message);} });
    $('#btnSignup').addEventListener('click', async ()=>{ const email=$('#email').value.trim(); const pass=$('#password').value; saveSchoolForEmail(); if(!email||pass.length<6) return alert('Ø¨Ø±ÙŠØ¯ ØµØ­ÙŠØ­ + ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); try{ await createUserWithEmailAndPassword(auth,email,pass); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨âœ…');}catch(e){ alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+e.message);} });
    $('#btnLogout').addEventListener('click', ()=> signOut(auth));

    onAuthStateChanged(auth, user=>{
      if(user){
        $('#authCard').classList.add('hidden'); $('#appUI').classList.remove('hidden');
        const email=user.email||''; const saved=localStorage.getItem(`schoolByEmail:${email.toLowerCase()}`)||''; setSchoolHeader(saved); $('#signedAs').textContent=email;
        refreshAll();
      }else{
        $('#authCard').classList.remove('hidden'); $('#appUI').classList.add('hidden'); setSchoolHeader(''); $('#signedAs').textContent='';
      }
    });

    // Collections
    const purchasesCol = ()=> collection(db,'users',auth.currentUser.uid,'purchases');
    const salesCol = ()=> collection(db,'users',auth.currentUser.uid,'sales');

    // Purchases save
    $('#btnAddPurchase').addEventListener('click', async ()=>{
      const date=$('#purchaseDate').value; const item=$('#purchaseItem').value; const qty=Number($('#purchaseQty').value||0); const cost=Number($('#purchaseCost').value||0); const price=Number($('#purchasePrice').value||0); const note=$('#purchaseNote').value.trim();
      if(!date||!item||qty<=0||price<=0) return alert('Ø±Ø§Ø¬Ø¹ ØªØ§Ø±ÙŠØ®/ØµÙ†Ù/ÙƒÙ…ÙŠØ©/Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹');
      try{ await addDoc(purchasesCol(),{date,item,qty,cost,price,note,createdAt:serverTimestamp()}); $('#purchaseQty').value='1'; $('#purchaseCost').value='0'; $('#purchasePrice').value='0'; $('#purchaseNote').value=''; await loadPurchasesTable(); await buildInventory(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª âœ…'); }catch(e){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+e.message);}
    });
    $('#btnClearPurchase').addEventListener('click', ()=>{ $('#purchaseQty').value='1'; $('#purchaseCost').value='0'; $('#purchasePrice').value='0'; $('#purchaseNote').value=''; });

    // Purchases filters + table
    document.getElementById('btnTogglePurchaseTable').addEventListener('click', ()=>{ document.getElementById('purchaseTable').classList.toggle('hidden'); document.getElementById('purchaseFilters').classList.toggle('hidden'); loadPurchasesTable(); });
    document.getElementById('btnApplyPurchaseFilters').addEventListener('click', ()=> loadPurchasesTable());
    document.getElementById('btnResetPurchaseFilters').addEventListener('click', ()=>{ $('#filterPurchaseDate').value=''; $('#filterPurchaseItem').value='Ø§Ù„ÙƒÙ„'; loadPurchasesTable(); });

    async function loadPurchasesTable(){
      const tbody=document.querySelector('#purchaseTable tbody'); tbody.innerHTML=''; if(!auth.currentUser) return;
      const snap=await getDocs(query(purchasesCol(), orderBy('date','desc')));
      let totalInventory=0; const fDate=$('#filterPurchaseDate')?.value||''; const fItem=$('#filterPurchaseItem')?.value||'Ø§Ù„ÙƒÙ„';
      snap.forEach(d=>{ const x=d.data(); if(fDate && x.date!==fDate) return; if(fItem!=='Ø§Ù„ÙƒÙ„' && x.item!==fItem) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.date}</td><td>${x.item}</td><td>${fmt(x.qty)}</td><td>${fmt(x.cost)}</td><td>${fmt(x.price)}</td><td>${fmt(x.qty*x.cost)}</td><td>${x.note||''}</td>`; tbody.appendChild(tr); totalInventory+=Number(x.qty||0); });
      document.getElementById('totalInventory').textContent=fmt(totalInventory);
      if(!tbody.children.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td class="muted" colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td>`; tbody.appendChild(tr); }
    }

    // Sales stock (Continuous inventory)
    let totalStock={"Ù…Ø§Ø¡":{qty:0,cost:0,price:0},"Ø¹ØµÙŠØ±":{qty:0,cost:0,price:0},"ÙØ·Ø§ÙŠØ±":{qty:0,cost:0,price:0}};
    async function buildInventory(){
      if(!auth.currentUser) return;
      const pSnap=await getDocs(purchasesCol());
      const sSnap=await getDocs(salesCol());

      const stockMap = new Map();
      pSnap.forEach(s => {
        const d = s.data();
        if (!stockMap.has(d.item)) stockMap.set(d.item, { qty: 0, cost: d.cost, price: d.price });
        const r = stockMap.get(d.item);
        r.qty += Number(d.qty || 0);
        // Ensure price and cost are updated to the latest purchase values
        r.cost = d.cost;
        r.price = d.price;
      });

      sSnap.forEach(s => {
        const x = s.data();
        if (stockMap.has(x.item)) {
          stockMap.get(x.item).qty -= Number(x.qty || 0);
        }
      });
      
      ["Ù…Ø§Ø¡", "Ø¹ØµÙŠØ±", "ÙØ·Ø§ÙŠØ±"].forEach(k => {
        const v = stockMap.get(k) || { qty: 0, cost: 0, price: 0 };
        totalStock[k] = v;
      });

      document.getElementById('avail-water').textContent = fmt(totalStock['Ù…Ø§Ø¡'].qty);
      document.getElementById('price-water').textContent = fmt(totalStock['Ù…Ø§Ø¡'].price);
      document.getElementById('cost-water').textContent = fmt(totalStock['Ù…Ø§Ø¡'].cost);

      document.getElementById('avail-juice').textContent = fmt(totalStock['Ø¹ØµÙŠØ±'].qty);
      document.getElementById('price-juice').textContent = fmt(totalStock['Ø¹ØµÙŠØ±'].price);
      document.getElementById('cost-juice').textContent = fmt(totalStock['Ø¹ØµÙŠØ±'].cost);

      document.getElementById('avail-pie').textContent = fmt(totalStock['ÙØ·Ø§ÙŠØ±'].qty);
      document.getElementById('price-pie').textContent = fmt(totalStock['ÙØ·Ø§ÙŠØ±'].price);
      document.getElementById('cost-pie').textContent = fmt(totalStock['ÙØ·Ø§ÙŠØ±'].cost);
    }
    document.getElementById('saleDate').addEventListener('change', ()=>{ document.getElementById('saleDay').value = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(new Date(document.getElementById('saleDate').value)); loadSalesTable(); });


    // Add sale
    document.getElementById('btnAddSale').addEventListener('click', async ()=>{
      const date=$('#saleDate').value; const note=$('#saleNote').value.trim();
      const entries=[{item:'Ù…Ø§Ø¡',qty:Number($('#qty-water').value||0)},{item:'Ø¹ØµÙŠØ±',qty:Number($('#qty-juice').value||0)},{item:'ÙØ·Ø§ÙŠØ±',qty:Number($('#qty-pie').value||0)}].filter(e=>e.qty>0);
      if(!date||!entries.length) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙƒÙ…ÙŠØ§Øª Ù…Ø¨Ø§Ø¹Ø©');

      try{
        for(const t of entries){
          const st = totalStock[t.item];
          if(t.qty > Number(st.qty || 0)) return alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØµÙ†Ù "${t.item}" ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØªÙˆÙØ± (${st.qty})`);
          
          await addDoc(salesCol(), {
            date,
            item: t.item,
            qty: t.qty,
            revenue: t.qty * Number(st.price || 0),
            profit: (t.qty * Number(st.price || 0)) - (t.qty * Number(st.cost || 0)), // Profit is calculated per item
            unitPrice: Number(st.price || 0),
            unitCost: Number(st.cost || 0),
            note,
            createdAt:serverTimestamp()
          });
        }
        $('#qty-water').value='0'; $('#qty-juice').value='0'; $('#qty-pie').value='0'; $('#saleNote').value='';
        await loadSalesTable();
        await buildInventory();
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ âœ…');
      } catch(e){
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹: '+e.message);
      }
    });

    document.getElementById('btnClearSale').addEventListener('click', ()=>{ $('#qty-water').value='0'; $('#qty-juice').value='0'; $('#qty-pie').value='0'; $('#saleNote').value=''; });

    // Sales table + filters
    document.getElementById('btnToggleSalesTable').addEventListener('click', ()=>{ document.getElementById('salesTable').classList.toggle('hidden'); document.getElementById('salesFilters').classList.toggle('hidden'); loadSalesTable(); });
    document.getElementById('btnApplySalesFilters').addEventListener('click', ()=> loadSalesTable());
    document.getElementById('btnResetSalesFilters').addEventListener('click', ()=>{ document.getElementById('filterSalesDate').value=''; document.getElementById('filterSalesItem').value='Ø§Ù„ÙƒÙ„'; loadSalesTable(); });
    async function loadSalesTable(){ const tbody=document.querySelector('#salesTable tbody'); tbody.innerHTML=''; if(!auth.currentUser) return; const snap=await getDocs(query(salesCol(), orderBy('date','desc'))); let sum=0; const fDate=document.getElementById('filterSalesDate')?.value||''; const fItem=document.getElementById('filterSalesItem')?.value||'Ø§Ù„ÙƒÙ„'; snap.forEach(d=>{ const x=d.data(); if(fDate && x.date!==fDate) return; if(fItem!=='Ø§Ù„ÙƒÙ„' && x.item!==fItem) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.date}</td><td>${x.item}</td><td>${fmt(x.qty)}</td><td>${fmt(x.revenue)}</td><td>${fmt(x.profit)}</td><td>${x.note||''}</td>`; tbody.appendChild(tr); sum+=Number(x.revenue||0); }); document.getElementById('dayRevenue').textContent=fmt(sum); if(!tbody.children.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td class="muted" colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td>`; tbody.appendChild(tr); } }

    // Reports (date range view)
    document.getElementById('btnRefreshReports').addEventListener('click', refreshReports);
    async function refreshReports(){
        if(!auth.currentUser) return;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;

        if (!startDate || !endDate) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ù„Ù„ØªÙ‚Ø±ÙŠØ±.');

        const qPurchases = query(purchasesCol(), where('date', '>=', startDate), where('date', '<=', endDate));
        const qSales = query(salesCol(), where('date', '>=', startDate), where('date', '<=', endDate));
        
        const pSnap = await getDocs(qPurchases);
        const sSnap = await getDocs(qSales);
        
        let sumCost=0, sumRevenue=0, sumProfit=0;
        const pBody = document.querySelector('#reportPurchaseTable tbody');
        const sBody = document.querySelector('#reportSalesTable tbody');
        pBody.innerHTML = '';
        sBody.innerHTML = '';

        pSnap.forEach(d => {
            const x = d.data();
            const tot = Number(x.qty || 0) * Number(x.cost || 0);
            sumCost += tot;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${x.date}</td><td>${x.item}</td><td>${fmt(x.qty)}</td><td>${fmt(x.cost)}</td><td>${fmt(x.price)}</td><td>${fmt(tot)}</td><td>${x.note || ''}</td>`;
            pBody.appendChild(tr);
        });
        
        sSnap.forEach(d => {
            const x = d.data();
            sumRevenue += Number(x.revenue || 0);
            sumProfit += Number(x.profit || 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${x.date}</td><td>${x.item}</td><td>${fmt(x.qty)}</td><td>${fmt(x.revenue)}</td><td>${fmt(x.profit)}</td><td>${x.note || ''}</td>`;
            sBody.appendChild(tr);
        });

        if (!pBody.children.length) { const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="7" style="color:#5f6b7a">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td>`; pBody.appendChild(tr); }
        if (!sBody.children.length) { const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" style="color:#5f6b7a">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td>`; sBody.appendChild(tr); }

        const depreciationRate = 0.05;
        const depreciation = sumProfit * depreciationRate;
        const sumNetProfit = sumProfit - depreciation;

        document.getElementById('sumCost').textContent = fmt(sumCost);
        document.getElementById('sumRevenue').textContent = fmt(sumRevenue);
        document.getElementById('sumProfit').textContent = fmt(sumProfit);
        document.getElementById('sumDepreciation').textContent = fmt(depreciation);
        document.getElementById('sumNetProfit').textContent = fmt(sumNetProfit);
    }

    // Data Deletion Functionality
    document.getElementById('btnDeleteData').addEventListener('click', async () => {
        if (!auth.currentUser) {
            return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        }

        const dateToDelete = document.getElementById('deleteDate').value;
        let confirmationMessage = '';
        let qPurchases, qSales;

        if (dateToDelete) {
            confirmationMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ØªØ§Ø±ÙŠØ® ${dateToDelete}ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.`;
            qPurchases = query(purchasesCol(), where('date', '==', dateToDelete));
            qSales = query(salesCol(), where('date', '==', dateToDelete));
        } else {
            confirmationMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.';
            qPurchases = query(purchasesCol());
            qSales = query(salesCol());
        }

        if (!confirm(confirmationMessage)) {
            return;
        }

        try {
            const purchasesSnapshot = await getDocs(qPurchases);
            const salesSnapshot = await getDocs(qSales);

            if (purchasesSnapshot.empty && salesSnapshot.empty) {
                return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­Ø°Ù.');
            }

            const deletePromises = [];

            purchasesSnapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });

            salesSnapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });

            await Promise.all(deletePromises);
            
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            refreshAll(); // Reload all tables
        } catch (e) {
            alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message);
        }
    });

    // Tabs
    document.querySelectorAll('#mainTabs button').forEach(b=> b.addEventListener('click', ()=>{ document.querySelectorAll('#purchases,#sales,#reports').forEach(s=> s.classList.add('hidden')); document.getElementById(b.dataset.page).classList.remove('hidden'); document.querySelectorAll('#mainTabs button').forEach(x=> x.classList.remove('active')); b.classList.add('active'); if(b.dataset.page==='purchases') loadPurchasesTable(); if(b.dataset.page==='sales'){ buildInventory(); loadSalesTable(); } if(b.dataset.page==='reports') refreshReports(); }));

    async function refreshAll(){ await loadPurchasesTable(); await buildInventory(); await loadSalesTable(); await refreshReports(); }
  </script>
</body>
</html>
